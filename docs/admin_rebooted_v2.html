
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>랜덤런치 관리자 V2</title>
  <style>
    body { font-family: Arial; padding: 40px; background: #f5f5f5; }
    #panel, #output { margin-top: 20px; display: none; }
    input, button { padding: 10px; font-size: 16px; margin: 5px 0; width: 100%; max-width: 300px; }
    .team-box { margin-top: 20px; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

<h1>👨‍🍳 랜덤런치 관리자 V2</h1>

<div id="login">
  <input type="password" id="pw" placeholder="비밀번호 입력" />
  <button onclick="login()">로그인</button>
</div>

<div id="panel">
  <input type="number" id="teamSize" placeholder="조당 인원 수 (예: 3)" min="1" />
  <button onclick="loadAndAssign()">조 편성 시작</button>
</div>

<div id="output"></div>

<script>
const PASSWORD = "lunchboss";
const applicantCSV = "https://docs.google.com/spreadsheets/d/1X0oWxxP0XuxRnw32x7vfp10U5UuZYj_KHi5rY1xftDk/gviz/tq?tqx=out:csv";
const staffCSV = "https://docs.google.com/spreadsheets/d/1nLCJ5UUyMnXx5urkTBqc3n-08U7vr2o69POWtNQvkuM/gviz/tq?tqx=out:csv";

function login() {
  const input = document.getElementById("pw").value;
  if (input === PASSWORD) {
    document.getElementById("login").style.display = "none";
    document.getElementById("panel").style.display = "block";
  } else {
    alert("비밀번호가 틀렸습니다");
  }
}

function normalize(str) {
  return str.trim().replace(/^["']|["']$/g, "").toLowerCase();
}

function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

async function loadAndAssign() {
  const teamSize = parseInt(document.getElementById("teamSize").value);
  if (isNaN(teamSize) || teamSize < 1) {
    alert("올바른 숫자를 입력해주세요.");
    return;
  }

  const [applicantText, staffText] = await Promise.all([
    fetch(applicantCSV).then(res => res.text()),
    fetch(staffCSV).then(res => res.text())
  ]);

  const applicantRows = applicantText.trim().split("\n").map(r => r.split(","));
  const staffRows = staffText.trim().split("\n").map(r => r.split(","));

  const applicants = applicantRows.slice(1)
    .map(r => normalize(r[1]))
    .filter(Boolean);

  const staffMap = {};
  staffRows.slice(1).forEach(r => {
    const key = normalize(r[2]);
    staffMap[key] = {
      name: r[2], service: r[0], department: r[1], gender: r[3]
    };
  });

  const matched = applicants.map(name => staffMap[name]).filter(Boolean);
  const males = shuffle(matched.filter(p => normalize(p.gender) === "m"));
  const females = shuffle(matched.filter(p => normalize(p.gender) === "w"));

  const total = shuffle([...males, ...females]);
  const used = new Set();
  const teams = [];

  while (total.length > 0) {
    let team = [];
    let deptUsed = new Set();
    let serviceUsed = new Set();
    let wCount = 0, mCount = 0;

    for (let i = 0; i < total.length && team.length < teamSize; i++) {
      const p = total[i];
      const key = normalize(p.name);
      const dept = normalize(p.department);
      const service = normalize(p.service);
      const gender = normalize(p.gender);

      if (!used.has(key) && !deptUsed.has(dept) && !serviceUsed.has(service)) {
        team.push(p);
        used.add(key);
        deptUsed.add(dept);
        serviceUsed.add(service);
        gender === "w" ? wCount++ : mCount++;
      }
    }

    // 조건 충족 못해도 남은 인원 무작위 채우기
    if (team.length < teamSize) {
      for (let i = 0; i < total.length && team.length < teamSize; i++) {
        const p = total[i];
        const key = normalize(p.name);
        if (!used.has(key)) {
          team.push(p);
          used.add(key);
        }
      }
    }

    if (team.length > 0) teams.push(team);
    total.splice(0, team.length);
  }

  const output = document.getElementById("output");
  output.style.display = "block";
  output.innerHTML = "<h2>조 편성 결과</h2>";

  teams.forEach((team, idx) => {
    const box = document.createElement("div");
    box.className = "team-box";
    box.innerHTML = `<strong>조 ${idx + 1}</strong><ul>` +
      team.map(p => `<li>${p.name} (${p.department}, ${p.gender}, ${p.service})</li>`).join("") +
      "</ul>";
    output.appendChild(box);
  });
}
</script>

</body>
</html>
